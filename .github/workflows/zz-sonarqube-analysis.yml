name: SonarQube-Analysis

on:
  #It is an internal tool, it can only ran a self hosted runner. Currently it can be triggered only manually.
  workflow_dispatch:
    inputs:
        branch:
            description: 'Branches to run the workflow on'
            required: true
            default: 'main'
jobs:
  sonarqube:
    ##TODO create a selfhosted runner by this name.
    runs-on: devs-self-hosted-runner
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch }}
      - name: Build Docker Image
        run: docker build -t  ${{ github.repository }}-build-env:latest Dockerfile
      - name: Run SonarQube analysis
        run: |
          docker run -u root --rm -v $(pwd):/home/${{ github.repository }}/ -w /home/${{ github.repository }}/ ${{ github.repository }}-build-env:latest /bin/sh -c "
            make all &&
            rm -rf sonar-bw &&
            rm -rf .scannerwork &&
            rm -rf locator_ncp/build &&
            rm -rf locator_host/build
            mkdir sonar-bw &&
            /opt/build-wrapper-linux-x86/build-wrapper-linux-x86-64 --out-dir sonar-bw/ make all &&
            sonar-scanner -Dsonar.token=$SONAR_TOKEN -Dsonar.host.url=$SONAR_HOST_URL"
      - name: Cleanup leftover files
        if: always()
        run: |
          docker run -u root --rm -v $(pwd):/home/${{ github.repository }}/ -w /home/${{ github.repository }}/ ${{ github.repository }}-build-env:latest /bin/sh -c "
          rm -rf sonar-bw && \
          rm -rf .scannerwork && \
          rm -rf locator_ncp/build && \
          rm -rf locator_host/build "
